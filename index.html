<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh; /* Ajustar la altura para ocupar toda la pantalla */
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([19.4326, -99.1332], 12); // Centrar en la Ciudad de México

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var locations = [];

        fetch('https://mapesquites-51a9dff5f52f.herokuapp.com/locations')
            .then(response => response.json())
            .then(data => {
                locations = data;
                data.forEach((location, index) => {
                    addMarker(location, index);
                });
            });

        function addMarker(location, index) {
            var marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(map)
                .bindPopup(
                    `<div>
                        <input type="text" id="name-${index}" placeholder="Nombre"><br>
                        <button onclick="saveMarker(${index})">Guardar</button>
                    </div>`
                )
                .openPopup();
        }

        map.on('dblclick', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            var location = { lat: lat, lng: lng };

            addMarker(location, locations.length);

            locations.push(location);
        });

        function saveMarker(index) {
            var location = locations[index];
            var name = document.getElementById(`name-${index}`).value;
            location.name = name;
            fetch('https://mapesquites-51a9dff5f52f.herokuapp.com/locations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(location)
            }).then(response => response.json())
              .then(data => {
                  console.log('Ubicación guardada:', data);
              });
        }

        // Crear un icono personalizado utilizando un archivo SVG
        var customIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/datavizero/mapesquites/main/corn-icon.svg',
            iconSize: [32, 32], // Tamaño del icono
            iconAnchor: [16, 32], // Punto del icono que se ubicará en la coordenada del marcador
            popupAnchor: [0, -32] // Punto desde el cual se abrirá el popup relativo al icono
        });

        // Función para añadir popup con el campo 'name'
        function onEachFeature(feature, layer) {
            if (feature.properties && feature.properties.name) {
                layer.bindPopup('Nombre: ' + feature.properties.name);
            }
        }

        // Cargar y mostrar GeoJSON al cargar la página con el icono personalizado y popup
        fetch('https://raw.githubusercontent.com/datavizero/mapesquites/main/esq_cdmx.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log('GeoJSON data loaded:', data); // Debug: Check if data is loaded
                L.geoJSON(data, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, { icon: customIcon });
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);
            })
            .catch(error => {
                console.error('Error cargando el archivo GeoJSON:', error);
            });
    </script>
</body>
</html>
